#+TITLE: Dotfiles

* Fresh Machine Setup

Clone the repo and run the install script:

#+begin_src sh
git clone https://github.com/jaybonthius/dotfiles.git ~/dotfiles
~/dotfiles/install.sh
#+end_src

This will:
1. Create a 4GiB swapfile and persist it to =/etc/fstab= (requires sudo)
2. Install GNU Guix (requires sudo; prompts for confirmation)
3. Authorize substitute servers (pre-built binaries)
4. Run =guix pull= to fetch the latest Guix (slow on first run)
5. Run =guix home reconfigure= to apply the home configuration
6. Compile custom terminfo entries (for true 24-bit color in Emacs)
7. Install fish shell plugins via fisher

After setup completes, log out and back in (or =source ~/.profile=) to
activate the environment.

** Individual Steps

You can run each step independently:

#+begin_src sh
~/dotfiles/install.sh setup-swap          # Create 4G swapfile (requires sudo)
~/dotfiles/install.sh install-guix       # Install Guix package manager
~/dotfiles/install.sh pull               # Update Guix
~/dotfiles/install.sh reconfigure        # Apply home configuration
~/dotfiles/install.sh compile-terminfo   # Compile custom terminfo entries
~/dotfiles/install.sh fish-plugins       # Install fish shell plugins
#+end_src

* System Configuration

** Swap

Ubuntu EC2 instances ship with no swap. Without swap, memory overcommit causes
the kernel to hard-freeze the machine (unresponsive, requires forced reboot)
instead of killing the offending process. =install.sh= creates a 4GiB swapfile
and persists it to =/etc/fstab= so it survives reboots.

To set up swap independently:

#+begin_src sh
~/dotfiles/install.sh setup-swap
#+end_src

** earlyoom

earlyoom is a userspace OOM killer. It monitors free memory and swap, and kills
the process with the worst OOM score before the kernel's own OOM killer would
act. This keeps the machine responsive under memory pressure instead of
hard-freezing.

It runs as a Shepherd service (managed by Guix Home) with default thresholds:
kills when either free memory or free swap drops below 10%.

To check its status:

#+begin_src sh
herd status earlyoom
#+end_src

* Git & SSH Setup

After the home environment is configured, set up Git authentication:

1. Remove the old manual gitconfig (if it exists):

   #+begin_src sh
   rm -f ~/.gitconfig
   #+end_src

2. Generate an SSH key:

   #+begin_src sh
   ssh-keygen -t ed25519 -C "your.username@email.com" -N ""
   #+end_src

3. Copy the public key:

   #+begin_src sh
   cat ~/.ssh/id_ed25519.pub
   #+end_src

4. Add it to GitHub: https://github.com/settings/ssh/new

5. Test the connection:

   #+begin_src sh
   ssh -T git@github.com
   #+end_src

6. Update the remote to use SSH:

   #+begin_src sh
   cd ~/dotfiles
   git remote set-url origin git@github.com:jaybonthius/dotfiles.git
   #+end_src


* Terminfo & True Color

Emacs in terminal mode (=emacs-no-x=) has a quirk in =term.c=: when
rendering a color whose pixel value is less than 8 via the standard
=setrgbf=/=setrgbb= terminfo path, it emits ANSI escape codes (e.g.
=\e[30m=) instead of 24-bit RGB sequences (=\e[38;2;R;G;Bm=). This
causes colors like =#000000= to be remapped to whatever the terminal
has configured for ANSI black, breaking themes like modus-operandi
that rely on exact foreground colors.

The fix is adding =setf24=/=setb24= capabilities to the terminfo
entry. Emacs checks for these first and uses unconditional
colon-separated SGR sequences with no ANSI fallback. The custom entry
lives in =terminfo/xterm-ghostty.ti= and is compiled into
=~/.terminfo/= by =install.sh compile-terminfo=.

This runs automatically during =install.sh setup=. To recompile
manually after editing the =.ti= file:

#+begin_src sh
~/dotfiles/install.sh compile-terminfo
#+end_src

* Other things

Install basedpyright after uv

#+begin_src sh
uv tool install basedpyright
#+end_src

To reload your emacs config, use

#+begin_src sh
herd restart emacs-daemon
#+end_src
